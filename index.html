<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>$BUMPER volume trading competiton</title>
  <meta name="color-scheme" content="dark light">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0609; --panel:#130e12; --muted:#9a90a4; --fg:#f2eaf2;
      --accent:#ff375f; --accent2:#ff7a59; --buy:#20e3a2; --sell:#ff5d7a;
      --gold:#ffd166; --silver:#cbd5e1; --bronze:#f4a261;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      background:
        radial-gradient(1100px 600px at 15% -10%, rgba(255,55,95,.12), transparent 60%),
        radial-gradient(900px 500px at 85% 8%, rgba(255,122,89,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,55,95,.05), transparent 40%), var(--bg);
      color:var(--fg);
    }
    a{color:#9bb5ff; text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1200px; margin:0 auto; padding:20px}

    header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:8px;}
    h1{font-size:42px; margin:0; letter-spacing:.2px}
    .muted{color:var(--muted)}
    .tzline{margin-top:6px; font-size:13px}

    .btn{
      border:1px solid rgba(255,255,255,.08); background:#1a1116; color:#fff;
      padding:9px 13px; border-radius:12px; font-weight:700; cursor:pointer;
      transition: transform .06s ease, box-shadow .15s ease, border-color .2s ease;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 8px 26px rgba(0,0,0,.25); border-color:rgba(255,255,255,.18)}
    .pill{padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); font-size:12px}

    /* HERO (cover) */
    .hero{
      position:relative; border-radius:16px; overflow:hidden; margin:10px 0 18px;
      border:1px solid rgba(255,55,95,.22); background:#140b0f; min-height:360px;
      box-shadow: 0 0 0 1px rgba(255,55,95,.18) inset, 0 14px 40px rgba(255,55,95,.15), 0 10px 30px rgba(0,0,0,.35);
    }
    .hero::before{
      content:""; position:absolute; inset:0;
      background:
        linear-gradient(180deg, rgba(10,5,7,.55), rgba(10,5,7,.18) 45%, rgba(10,5,7,.04) 85%),
        url('./bumpertrading.png') center / cover no-repeat;
      filter:saturate(1.05) contrast(1.02) brightness(1.02);
    }

    /* Floating micro-cards pinned to bottom of the hero */
    .overlay{
      position:absolute; left:12px; right:12px; bottom:12px; top:auto;
      display:flex; justify-content:space-between; gap:12px; pointer-events:none;
    }
    .floater{
      pointer-events:auto;
      min-width:260px; max-width:420px;
      background:rgba(20,12,16,.22);              /* più trasparente */
      backdrop-filter:saturate(1.05) blur(5px);   /* blur leggero */
      border:1px solid rgba(255,55,95,.18);
      border-radius:12px; padding:10px 12px;
      box-shadow:0 10px 26px rgba(0,0,0,.28), inset 0 0 0 1px rgba(255,55,95,.08);
    }
    .floater h4{
      margin:0 0 6px 0; font-size:13px; letter-spacing:.3px; text-transform:uppercase; color:#fff;
    }
    .kv{display:grid; grid-template-columns: 68px 1fr; gap:4px 8px; font-size:13px}
    .kv .k{color:var(--muted)}
    .status{font-weight:800; font-size:13px}
    .ok{color:var(--buy)} .end{color:var(--sell)} .ns{color:#b7b1c5}

    .bar{height:6px; background:rgba(0,0,0,.22); border:1px solid rgba(255,55,95,.18); border-radius:999px; overflow:hidden; margin-top:6px}
    .bar > i{display:block; height:100%; background:linear-gradient(90deg, var(--accent), var(--accent2)); width:0%}
    .barline{display:flex; justify-content:space-between; align-items:center; margin-top:4px; font-size:12px; color:var(--muted)}

    /* Panels below hero */
    .grid{display:grid; grid-template-columns: 1.25fr .95fr; gap:16px;}
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent 60%), var(--panel);
      border-radius:16px; padding:14px 16px;
      border:1px solid rgba(255,55,95,.22);
      box-shadow: 0 0 0 1px rgba(255,55,95,.10) inset, 0 4px 30px rgba(0,0,0,.25);
    }
    .panel h3{margin:0 0 8px 0; font-size:16px; letter-spacing:.2px}

    .cards{display:grid; grid-template-columns: repeat(3,1fr); gap:12px; margin-bottom:10px;}
    @media (max-width: 700px){ .cards{ grid-template-columns:1fr; } }
    .card{background:#110a0e; border-radius:14px; padding:12px; border:1px solid rgba(255,55,95,.22); box-shadow: 0 0 0 1px rgba(255,55,95,.10) inset, 0 8px 26px rgba(0,0,0,.25);}
    .k{font-size:12px; color:var(--muted); margin-bottom:4px}
    .v{font-size:22px; font-weight:800}

    .leader{border-radius:12px; overflow:auto; border:1px solid rgba(255,55,95,.22); max-height:56vh; box-shadow: 0 0 0 1px rgba(255,55,95,.10) inset;}
    table{width:100%; border-collapse:collapse; font-size:14px}
    thead th{position:sticky; top:0; background:#160c10; z-index:1; padding:10px; text-align:left; font-weight:800; letter-spacing:.2px; border-bottom:1px solid rgba(255,55,95,.35); cursor:pointer; user-select:none;}
    tbody td{ padding:10px; border-bottom:1px dashed rgba(255,255,255,.10); }
    tbody tr:hover{ background: rgba(255,55,95,.08); }
    .right{text-align:right}
    .rank{width:86px; font-weight:800; white-space:nowrap}
    .pos{margin-right:6px}
    .addr{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    .trophy{ font-size:18px } .r1 .trophy{ color: var(--gold) } .r2 .trophy{ color: var(--silver) } .r3 .trophy{ color: var(--bronze) }

    .feed{display:flex; flex-direction:column; gap:10px; max-height:56vh; overflow:auto; border-radius:12px; border:1px solid rgba(255,55,95,.22); padding:10px; box-shadow: 0 0 0 1px rgba(255,55,95,.10) inset;}
    .ev{display:flex; align-items:center; gap:10px; background:#150c10; border:1px solid rgba(255,55,95,.22); padding:10px; border-radius:12px; box-shadow: 0 0 0 1px rgba(255,55,95,.08) inset;}
    .badge{font-size:11px; font-weight:800; padding:4px 8px; border-radius:999px; letter-spacing:.25px; border:1px solid rgba(255,255,255,.12);}
    .buy{ color:var(--buy); background: rgba(32,227,162,.10); }
    .sell{ color:var(--sell); background: rgba(255,93,122,.12); border-color: rgba(255,93,122,.24); }
    .ev .time{ color:var(--muted); font-size:12px; min-width:110px }
    .ev .tx{ margin-left:auto; font-size:12px }

    .foot{ margin-top:12px; color:var(--muted); font-size:12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center }
    .sep{ opacity:.22 }
    .small{ font-size:12px }

    .spinner{ width:14px; height:14px; border:2px solid rgba(255,255,255,.15); border-top-color:var(--accent); border-radius:50%; animation:spin .85s linear infinite; display:inline-block; vertical-align:-2px; }
    @keyframes spin{ to { transform: rotate(360deg) } }
    .toast{ position: fixed; right: 16px; bottom: 16px; background: #150c10; border:1px solid rgba(255,55,95,.24); padding:10px 12px; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,.35); max-width: 320px; }
    .hidden{ display:none }

    /* mobile overlay stacking */
    @media (max-width: 900px){
      .overlay{flex-direction:column; align-items:flex-start}
      .floater{max-width:calc(100% - 24px)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>$BUMPER volume trading competiton</h1>
        <div id="tzline" class="tzline muted">Times shown in <strong>Europe/Rome</strong></div>
      </div>
      <div class="controls" style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="btn-refresh">Refresh now</button>
        <span class="pill" id="live-pill">Live</span>
      </div>
    </header>

    <!-- HERO with translucent micro-cards pinned to bottom -->
    <div class="hero" aria-label="Bumper cover image">
      <div class="overlay">
        <!-- Contest micro-card -->
        <div class="floater" style="flex:1">
          <h4>Contest</h4>
          <div class="kv">
            <div class="k">Start</div>  <div id="c-start" class="muted">—</div>
            <div class="k">End</div>    <div id="c-end" class="muted">—</div>
            <div class="k">Status</div> <div id="c-status" class="status ns">—</div>
          </div>
          <div class="bar"><i id="c-bar" style="width:0%"></i></div>
          <div class="barline">
            <span id="c-percent">0%</span>
            <span id="c-left">—</span>
          </div>
        </div>

        <!-- Refresh micro-card -->
        <div class="floater" style="width:320px">
          <h4>Refresh</h4>
          <div class="kv">
            <div class="k">Next</div> <div id="next-ref">—</div>
            <div class="k">Updated</div> <div id="last-upd">—</div>
          </div>
          <div id="status-pill" class="small"><span class="spinner"></span> Loading…</div>
        </div>
      </div>
    </div>

    <!-- Body -->
    <div class="grid">
      <section class="panel">
        <h3>Leaderboard (cumulative)</h3>
        <div class="cards">
          <div class="card"><div class="k">Total Volume (BUMPER)</div><div class="v" id="tot-volume">—</div></div>
          <div class="card"><div class="k">Total Buy (BUMPER)</div><div class="v" id="tot-buy">—</div></div>
          <div class="card"><div class="k">Total Sell (BUMPER)</div><div class="v" id="tot-sell">—</div></div>
        </div>
        <div class="leader">
          <table id="tbl">
            <thead>
              <tr>
                <th data-sort="rank" style="width:86px">Rank</th>
                <th data-sort="address">Wallet</th>
                <th class="right" data-sort="buy">Buy</th>
                <th class="right" data-sort="sell">Sell</th>
                <th class="right" data-sort="volume">Volume</th>
                <th data-sort="trades">Trades</th>
                <th data-sort="last">Last Tx (UTC)</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="foot">
          <span>Data source:</span>
          <a id="lb-link" target="_blank" rel="noopener">leaderboard.json</a>
          <span class="sep">|</span>
          <span id="lb-count" class="muted">0 wallets</span>
        </div>
      </section>

      <section class="panel">
        <h3>Latest Trades</h3>
        <div class="feed" id="feed"></div>
        <div class="foot">
          <span>Data source:</span>
          <a id="ev-link" target="_blank" rel="noopener">latest_events.json</a>
          <span class="sep">|</span>
          <span class="muted">Rendered directly from the file (newest first).</span>
        </div>
      </section>
    </div>
  </div>

  <div class="toast hidden" id="toast"></div>

  <script>
    // ====== CONFIG ======
    const DATA_BASE = window.DATA_BASE || 'https://happydao.github.io/bumper-trading-contest/data';
    const REFRESH_SECONDS = 60;

    // ====== DOM ======
    const elTZLine = document.getElementById('tzline');
    const elNextRef = document.getElementById('next-ref');
    const elLastUpd = document.getElementById('last-upd');
    const elStatus = document.getElementById('status-pill');
    const elTotVol = document.getElementById('tot-volume');
    const elTotBuy = document.getElementById('tot-buy');
    const elTotSell = document.getElementById('tot-sell');
    const elLbCount = document.getElementById('lb-count');
    const elLbLink = document.getElementById('lb-link');
    const elEvLink = document.getElementById('ev-link');
    const elTBody = document.getElementById('tbody');
    const elFeed = document.getElementById('feed');
    const btnRefresh = document.getElementById('btn-refresh');

    // contest overlay elements
    const elCStart = document.getElementById('c-start');
    const elCEnd = document.getElementById('c-end');
    const elCStatus = document.getElementById('c-status');
    const elCBar = document.getElementById('c-bar');
    const elCPercent = document.getElementById('c-percent');
    const elCLeft = document.getElementById('c-left');

    let sortField = 'volume';
    let sortDir = 'desc';
    let refreshCountdown = REFRESH_SECONDS;
    let countdownTimer = null;

    // ====== Utils ======
    const fmtInt = (n) => Math.floor(Number(n||0)).toLocaleString('en-US');
    const ago = (iso) => {
      const d = new Date(iso);
      const sec = Math.max(0, Math.round((Date.now() - d.getTime())/1000));
      if (sec < 60) return `${sec}s ago`;
      const m = Math.round(sec/60); if (m < 60) return `${m}m ago`;
      const h = Math.round(m/60); return `${h}h ago`;
    };
    const mask = (addr) => addr; // backend already masked
    const linkSolscan = (tx)=> `https://solscan.io/tx/${tx}`;
    const itDateTime = (iso, tz) => new Date(iso).toLocaleString('it-IT', { timeZone: tz, hour12:false });

    function showToast(msg, ok=false){
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.remove('hidden');
      toast.style.border = ok ? '1px solid rgba(32,227,162,.35)' : '1px solid rgba(255,93,122,.35)';
      toast.style.color = ok ? 'var(--buy)' : 'var(--sell)';
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.classList.add('hidden'), 3500);
    }
    async function fetchJSON(name){
      const url = `${DATA_BASE}/${name}.json?t=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`GET ${name}.json → HTTP ${res.status}`);
      return await res.json();
    }
    function setStatus(text, spinning=true){
      elStatus.innerHTML = (spinning ? '<span class="spinner"></span> ' : '') + text;
    }
    function startCountdown(){
      clearInterval(countdownTimer);
      refreshCountdown = REFRESH_SECONDS;
      countdownTimer = setInterval(()=>{
        refreshCountdown--;
        elNextRef.textContent = `${refreshCountdown}s`;
        if (refreshCountdown <= 0){
          clearInterval(countdownTimer);
          refreshNow();
        }
      }, 1000);
    }

    // ===== Contest helpers =====
    function progressInfo(c){
      if (!c || !c.start_iso || !c.end_iso) return {percent:0, label:'—', status:'ns'};
      const now = Date.now();
      const s = Date.parse(c.start_iso);
      const e = Date.parse(c.end_iso);
      if (now < s){
        const sec = Math.max(0, Math.round((s-now)/1000));
        return { percent:0, label:`starts in ${hum(sec)}`, status:'ns' };
      }
      if (now >= e){
        return { percent:100, label:`ended`, status:'end' };
      }
      const percent = Math.max(0, Math.min(100, ((now-s)/(e-s))*100));
      const sec = Math.max(0, Math.round((e-now)/1000));
      return { percent, label:`time left: ${hum(sec)}`, status:'ok' };
    }
    function hum(sec){
      if (sec < 60) return `${sec}s`;
      const m = Math.floor(sec/60); if (m < 60) return `${m}m`;
      const h = Math.floor(m/60); const r = m%60;
      return r ? `${h}h ${r}m` : `${h}h`;
    }

    function renderContest(meta, lastRunIso){
      const tz = (meta && meta.timezone) || 'Europe/Rome';
      elTZLine.innerHTML = `Times shown in <strong>${tz}</strong>`;
      if (!meta || !meta.start_iso || !meta.end_iso){
        elCStart.textContent = '—'; elCEnd.textContent = '—';
        elCStatus.textContent = '—'; elCStatus.className = 'status ns';
        elCBar.style.width = '0%'; elCPercent.textContent = '0%'; elCLeft.textContent = '—';
        elLastUpd.textContent = lastRunIso ? itDateTime(lastRunIso, tz) : '—';
        return;
      }
      elCStart.textContent = itDateTime(meta.start_iso, tz);
      elCEnd.textContent   = itDateTime(meta.end_iso, tz);

      const p = progressInfo(meta);
      elCBar.style.width = `${p.percent.toFixed(1)}%`;
      elCPercent.textContent = `${Math.round(p.percent)}%`;
      elCLeft.textContent = p.label;
      elCStatus.textContent = p.status==='ok' ? 'Running' : (p.status==='end' ? 'Ended' : 'Not started');
      elCStatus.className = `status ${p.status}`;
      elLastUpd.textContent = lastRunIso ? itDateTime(lastRunIso, tz) : '—';
    }

    // ===== Leaderboard render =====
    function renderLeaderboard(data){
      window._lastLeaderboard = data;
      const wallets = (data.wallets || []).slice();

      wallets.sort((a,b)=>{
        const fa = getField(a, sortField);
        const fb = getField(b, sortField);
        const cmp = (fa > fb) ? 1 : (fa < fb ? -1 : 0);
        return sortDir === 'asc' ? cmp : -cmp;
      });

      const tbody = elTBody; tbody.innerHTML = '';
      wallets.forEach((w,i)=>{
        const posStr = `${i+1}°`;
        const trophy = i<3 ? `<span class="trophy">🏆</span>` : '';
        const tr = document.createElement('tr');
        if (i===0) tr.classList.add('r1');
        if (i===1) tr.classList.add('r2');
        if (i===2) tr.classList.add('r3');
        tr.innerHTML = `
          <td class="rank"><span class="pos">${posStr}</span> ${trophy}</td>
          <td class="addr">${mask(w.address)}</td>
          <td class="right">${fmtInt(w.buy)}</td>
          <td class="right">${fmtInt(w.sell)}</td>
          <td class="right"><strong>${fmtInt(w.volume)}</strong></td>
          <td>${w.trades ?? 0}</td>
          <td class="small">${w.last_tx_iso ? new Date(w.last_tx_iso).toISOString().replace('.000','') : '—'}</td>
        `;
        tbody.appendChild(tr);
      });

      const c = data.cumulative || { total_buy:0, total_sell:0, total_volume:0 };
      elTotVol.textContent = fmtInt(c.total_volume || 0);
      elTotBuy.textContent = fmtInt(c.total_buy || 0);
      elTotSell.textContent = fmtInt(c.total_sell || 0);
      elLbCount.textContent = `${wallets.length} wallet${wallets.length===1?'':'s'}`;
      elLbLink.href = `${DATA_BASE}/leaderboard.json`;
    }
    function getField(w, field){
      switch(field){
        case 'address': return w.address || '';
        case 'buy': return +w.buy || 0;
        case 'sell': return +w.sell || 0;
        case 'volume': return +w.volume || 0;
        case 'trades': return +w.trades || 0;
        case 'last': return w.last_tx_iso ? Date.parse(w.last_tx_iso) : 0;
        default: return 0;
      }
    }
    document.querySelectorAll('thead th').forEach(th=>{
      th.addEventListener('click', ()=>{
        const f = th.dataset.sort;
        if (!f) return;
        if (sortField === f) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
        else { sortField = f; sortDir = (f === 'address' || f === 'rank') ? 'asc' : 'desc'; }
        if (window._lastLeaderboard) renderLeaderboard(window._lastLeaderboard);
      });
    });

    // ===== Events feed =====
    function renderFeed(eventsObj){
      const src = (eventsObj.events || [])
        .slice()
        .sort((a,b)=> Date.parse(b.ts_iso || 0) - Date.parse(a.ts_iso || 0));
      elEvLink.href = `${DATA_BASE}/latest_events.json`;
      elFeed.innerHTML = '';
      if (!src.length){
        elFeed.innerHTML = `<div class="muted" style="padding:6px 2px">No trades in feed.</div>`;
        return;
      }
      for (const e of src){
        const badge = e.type === 'BUY' ? `<span class="badge buy">BUY</span>` : `<span class="badge sell">SELL</span>`;
        const when = e.ts_it || e.ts_iso || '';
        const rel = e.ts_iso ? ago(e.ts_iso) : '';
        const div = document.createElement('div');
        div.className = 'ev';
        div.innerHTML = `
          ${badge}
          <div class="addr">${mask(e.wallet)}</div>
          <div class="st">${fmtInt(e.amount)} BUMPER</div>
          <div class="time">${when} <span class="muted">(${rel})</span></div>
          <div class="tx"><a href="${linkSolscan(e.tx)}" target="_blank" rel="noopener">solscan ↗</a></div>
        `;
        elFeed.appendChild(div);
      }
    }

    // ===== Refresh flow =====
    async function refreshNow(){
      try{
        setStatus('Loading…', true);
        const [lb, ev] = await Promise.all([ fetchJSON('leaderboard'), fetchJSON('latest_events') ]);
        const contest = ev.contest || lb.contest || null;
        renderContest(contest, ev.run_at_iso || lb.updated_at || null);
        renderLeaderboard(lb);
        renderFeed(ev);
        setStatus('Live', false);
        elNextRef.textContent = `${REFRESH_SECONDS}s`;
        startCountdown();
        showToast('Data updated', true);
      } catch (e){
        console.error(e);
        setStatus('Error');
        showToast(e.message || 'Failed to refresh');
        startCountdown();
      }
    }

    document.getElementById('btn-refresh').addEventListener('click', refreshNow);

    // boot
    (async function(){
      document.getElementById('lb-link').href = `${DATA_BASE}/leaderboard.json`;
      document.getElementById('ev-link').href = `${DATA_BASE}/latest_events.json`;
      await refreshNow();
    })();
  </script>
</body>
</html>
